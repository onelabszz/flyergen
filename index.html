<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flyer Generator GitHub</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;800&display=swap" rel="stylesheet">
    
    <style>
      /* CSS SAMA PERSIS DENGAN SEBELUMNYA */
      body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
      .panel { background: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; }
      .panel-left { flex: 1; min-width: 300px; }
      .panel-right { flex: 1.5; background: #e4e6eb; border: 2px dashed #ccc; overflow: auto; align-items: center; }
      textarea { width: 100%; height: 200px; background: #282c34; color: #abb2bf; border: none; border-radius: 8px; padding: 15px; box-sizing: border-box; }
      #flyer-canvas { background: white; margin-top: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); cursor: text; }
      .btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; }
      .btn-blue { background: #3498db; }
      .btn-green { background: #27ae60; margin-top: auto; }
      
      @media (max-width: 768px) { body { flex-direction: column; height: auto; } }
    </style>
  </head>
  <body>

    <div class="panel panel-left">
      <h3>üõ†Ô∏è Config (GitHub Version)</h3>
      <p style="font-size:12px">Paste HTML Flyer:</p>
      <textarea id="htmlInput" placeholder="Loading settings..."></textarea>
      <button class="btn btn-blue" onclick="renderPreview()">üîÑ Update Preview</button>
      <p style="font-size:12px; margin-top:20px;">Status: <span id="statusMsg">Connecting...</span></p>
      <button class="btn btn-green" id="btnDownload" onclick="downloadFlyer()">‚¨áÔ∏è Download</button>
    </div>

    <div class="panel panel-right">
      <div id="flyer-canvas" contenteditable="true" spellcheck="false">
        <div style="padding:50px;">Waiting for API...</div>
      </div>
    </div>

    <script>
      // !!! PASTE URL DARI DEPLOYMENT APPS SCRIPT DI SINI !!!
      const API_URL = "https://script.google.com/macros/s/AKfycbzEd4YG1VlOFcbgVip6XrOe4quWAImkvcOvzVerTYavMkiuU1F6nSmoxd56b7DbEw7W/exec";

      window.onload = function() {
        setStatus("Menghubungi Database Google...");
        
        // GANTI google.script.run dengan FETCH
        fetch(API_URL + "?action=getSettings")
          .then(response => response.json())
          .then(data => {
             setupAwal(data);
          })
          .catch(error => {
             console.error(error);
             setStatus("Error koneksi ke GAS!");
          });
      };

      function setupAwal(settings) {
        setStatus("Ready.");
        var template = `
          <div style="width: 400px; height: 550px; background: ${settings.WarnaBackground}; font-family: 'Poppins', sans-serif; color: white; text-align: center; display: flex; flex-direction: column;">
            <div style="padding: 40px;">
              <h2>${settings.JudulDefault}</h2>
              <h1 style="font-size: 48px;">NAMA<br>DISINI</h1>
            </div>
            <div style="margin-top: auto; padding: 15px; background: rgba(0,0,0,0.2);">${settings.FooterText}</div>
          </div>
        `;
        document.getElementById('htmlInput').value = template;
        renderPreview();
      }

      function renderPreview() {
        document.getElementById('flyer-canvas').innerHTML = document.getElementById('htmlInput').value;
      }

      function downloadFlyer() {
        var element = document.getElementById("flyer-canvas");
        var btn = document.getElementById("btnDownload");
        
        btn.disabled = true;
        btn.innerHTML = "‚è≥ Generating...";
        element.setAttribute("contenteditable", "false");

        html2canvas(element, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
          // 1. Download
          var link = document.createElement('a');
          link.download = 'Flyer-GitHub.png';
          link.href = canvas.toDataURL("image/png");
          link.click();

          // 2. Kirim Log ke GAS (Pakai Fetch POST)
          setStatus("Menyimpan log...");
          
          // Menggunakan 'no-cors' atau text/plain untuk menghindari preflight issue di GAS
          fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: "saveLog",
              isiFlyer: element.innerText
            })
          }).then(() => {
             setStatus("Selesai!");
             element.setAttribute("contenteditable", "true");
             btn.disabled = false;
             btn.innerHTML = "‚¨áÔ∏è Download";
          });
        });
      }

      function setStatus(msg) { document.getElementById('statusMsg').innerText = msg; }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flyer Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* CSS SAMA SEPERTI SEBELUMNYA */
        :root { --primary: #4f46e5; --dark: #1e1e2e; --bg: #f3f4f6; --sidebar-w: 400px; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); height: 100vh; display: flex; overflow: hidden; }
        
        .sidebar { width: var(--sidebar-w); background: white; padding: 25px; display: flex; flex-direction: column; border-right: 1px solid #e5e7eb; z-index: 10; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        h1 { font-size: 18px; color: var(--dark); margin: 0; font-weight: 800; }
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
        .badge-user { background: #e0e7ff; color: var(--primary); }
        .badge-admin { background: #dcfce7; color: #166534; }

        #admin-panel, #user-panel { display: none; flex: 1; flex-direction: column; }
        .editor-box { flex: 1; background: #111827; color: #a5b4fc; border-radius: 8px; padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 12px; resize: none; border: none; outline: none; margin-bottom: 15px; }
        
        #dynamic-form { flex: 1; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        label { font-size: 12px; font-weight: 600; color: #374151; display: block; margin-bottom: 6px; }
        input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; }
        
        .btn { padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-save { background: #059669; }
        
        .preview-area { flex: 1; background: #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: auto; padding: 40px; }
        #flyer-canvas { background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.15); display: inline-block; min-width: 100px; min-height: 100px; }
        
        @media (max-width: 800px) { body { flex-direction: column; overflow: auto; height: auto; } .sidebar { width: 100%; height: auto; } .preview-area { min-height: 500px; } }
        #loader { position: fixed; inset: 0; background: white; z-index: 999; display: flex; align-items: center; justify-content: center; }
    </script>
</head>
<body>

    <div id="loader"><h3>Menghubungkan ke Database...</h3></div>

    <div class="sidebar">
        <div class="header">
            <h1 id="app-title">Flyer App</h1>
            <span id="role-badge" class="badge badge-user">USER MODE</span>
        </div>

        <div id="admin-panel">
            <p style="font-size:12px">Paste HTML (Inline CSS) dari Gemini:</p>
            <textarea id="htmlInput" class="editor-box"></textarea>
            <button class="btn btn-save" onclick="saveTemplate()">üíæ Simpan Desain</button>
            <button class="btn btn-primary" onclick="renderAdminPreview()" style="background:#64748b">üîÑ Test Preview</button>
        </div>

        <div id="user-panel">
            <div id="dynamic-form"></div>
            <button class="btn btn-primary" id="btnDL" onclick="downloadImage()">‚¨áÔ∏è Download Gambar</button>
        </div>
    </div>

    <div class="preview-area">
        <div id="flyer-canvas"></div>
    </div>

    <script>
        // --- KONFIGURASI PENTING ---
        // Masukkan URL Deployment Google Apps Script Anda di sini
        const API_URL = "https://script.google.com/macros/s/AKfycbzEd4YG1VlOFcbgVip6XrOe4quWAImkvcOvzVerTYavMkiuU1F6nSmoxd56b7DbEw7W/exec"; 

        let RAW_TEMPLATE = "";

        window.onload = function() {
            // Ambil Parameter URL ?mode=12345
            const urlParams = new URLSearchParams(window.location.search);
            const modeParam = urlParams.get('mode');

            // 1. FETCH DATA DARI GAS (GET)
            fetch(API_URL + "?action=getSettings")
                .then(res => res.json())
                .then(data => {
                    document.getElementById('app-title').innerText = data.JudulApp;

                    // Cek Apakah Admin?
                    if (modeParam && modeParam === data.PasscodeAdmin) {
                        initAdmin(data.TemplateAktif);
                    } else {
                        initUser(data.TemplateAktif);
                    }
                    document.getElementById('loader').style.display = 'none';
                })
                .catch(err => {
                    alert("Gagal koneksi ke Database. Cek Console.");
                    console.error(err);
                });
        };

        // --- ADMIN FUNCTIONS ---
        function initAdmin(template) {
            document.getElementById('admin-panel').style.display = 'flex';
            document.getElementById('role-badge').className = 'badge badge-admin';
            document.getElementById('role-badge').innerText = 'ADMIN CREATOR';
            if(template) {
                document.getElementById('htmlInput').value = template;
                renderAdminPreview();
            }
        }

        function saveTemplate() {
            const code = document.getElementById('htmlInput').value;
            const btn = document.querySelector('.btn-save');
            btn.innerText = "‚è≥ Menyimpan..."; btn.disabled = true;

            // KIRIM DATA KE GAS (POST)
            // Gunakan no-cors atau text/plain untuk bypass CORS preflight sederhana
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "saveTemplate", payload: code })
            }).then(res => {
                alert("Desain berhasil disimpan! Semua user akan melihat update ini.");
                btn.innerText = "üíæ Simpan Desain"; btn.disabled = false;
            });
        }

        function renderAdminPreview() {
            document.getElementById('flyer-canvas').innerHTML = document.getElementById('htmlInput').value;
        }

        // --- USER FUNCTIONS ---
        function initUser(template) {
            document.getElementById('user-panel').style.display = 'flex';
            RAW_TEMPLATE = template || "<div style='padding:20px'>Belum ada desain.</div>";
            document.getElementById('flyer-canvas').innerHTML = RAW_TEMPLATE;
            generateForm(RAW_TEMPLATE);
        }

        function generateForm(html) {
            const container = document.getElementById('dynamic-form');
            container.innerHTML = "";
            const regex = /{{\s*(.*?)\s*}}/g;
            let match;
            const labels = new Set();

            while ((match = regex.exec(html)) !== null) {
                const label = match[1];
                if(!labels.has(label)) {
                    labels.add(label);
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `<label>${label}</label><input type="text" data-target="${label}" onkeyup="updateLive()" placeholder="Isi ${label}...">`;
                    container.appendChild(div);
                }
            }
            if(labels.size === 0) container.innerHTML = "<p>Tidak ada data yang perlu diisi.</p>";
        }

        function updateLive() {
            let html = RAW_TEMPLATE;
            document.querySelectorAll('#dynamic-form input').forEach(input => {
                const target = input.getAttribute('data-target');
                const val = input.value || target;
                html = html.replace(new RegExp("{{\\s*" + target + "\\s*}}", "g"), val);
            });
            document.getElementById('flyer-canvas').innerHTML = html;
        }

        function downloadImage() {
            const el = document.getElementById("flyer-canvas");
            const btn = document.getElementById("btnDL");
            btn.innerText = "‚è≥ Proses..."; btn.disabled = true;

            html2canvas(el, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Flyer-Saya.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                
                // LOG USER (Fire and forget)
                fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "saveLog", payload: "User Download" })
                });

                btn.innerText = "‚¨áÔ∏è Download Gambar"; btn.disabled = false;
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flyer Generator Pro (Material You)</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            /* Material You Inspired Colors */
            --primary-color: #6750a4; /* M3 Purple */
            --primary-container: #eaddff;
            --on-primary-container: #21005d;
            --surface-color: #fdfcff;
            --surface-container: #f3f6fc;
            --outline-color: #79747e;
            --sidebar-width: 420px;
            --border-radius-lg: 28px;
            --border-radius-md: 16px;
            --border-radius-sm: 8px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--surface-container);
            color: #1c1b1f;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        /* Layout Structure */
        .wrapper {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Material You Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface-color);
            display: flex;
            flex-direction: column;
            border-right: none;
            flex-shrink: 0;
            z-index: 100;
            box-shadow: 2px 0 0 rgba(0,0,0,0.02);
            transition: margin 0.3s ease;
        }

        .sidebar-header {
            padding: 1.5rem 2rem;
            background: var(--surface-color);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 2rem 2rem 2rem;
            scrollbar-width: thin;
        }
        
        .sidebar-content::-webkit-scrollbar { width: 6px; }
        .sidebar-content::-webkit-scrollbar-thumb { background-color: #e0e0e0; border-radius: 10px; }

        .sidebar-footer {
            padding: 1.5rem 2rem;
            background: var(--surface-container);
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        /* Main Preview Area */
        .main-content {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: var(--border-radius-lg) 0 0 var(--border-radius-lg);
            background-color: #ffffff;
            margin: 10px 10px 10px 0;
            box-shadow: -5px 0 20px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .preview-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            padding: 40px;
            background-image: radial-gradient(#e0e0e0 1.5px, transparent 1.5px);
            background-size: 24px 24px;
            border-radius: var(--border-radius-lg) 0 0 var(--border-radius-lg);
        }

        /* Material Components Overrides */
        
        /* Buttons */
        .btn {
            border-radius: 100px; /* Pill shape */
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-transform: none;
            letter-spacing: 0.3px;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #55418b;
            border-color: #55418b;
            box-shadow: 0 4px 8px rgba(103, 80, 164, 0.3);
            transform: translateY(-1px);
        }

        .btn-outline-secondary {
            border-color: #79747e;
            color: #49454f;
        }

        .btn-outline-secondary:hover {
            background-color: #f0f0f0;
            color: #1d1b20;
            border-color: #1d1b20;
        }

        /* Inputs */
        .form-control {
            border-radius: var(--border-radius-md);
            background-color: #f0f4f8; /* Surface Variant */
            border: 2px solid transparent;
            padding: 0.85rem 1rem;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            background-color: #ffffff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--primary-container);
        }

        .input-group .btn {
            border-top-right-radius: var(--border-radius-md) !important;
            border-bottom-right-radius: var(--border-radius-md) !important;
            z-index: 5;
        }
        
        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        /* Preset Cards */
        .btn-preset {
            height: 100px;
            border-radius: var(--border-radius-md);
            background-color: var(--surface-container);
            border: 1px solid transparent;
            color: #49454f;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .btn-preset:hover, .btn-preset.active {
            background-color: var(--primary-container);
            color: var(--on-primary-container);
            border-color: transparent;
        }
        
        .btn-preset i { font-size: 1.75rem; }

        /* Color Picker */
        .form-control-color {
            width: 100%;
            height: 50px;
            border-radius: var(--border-radius-md);
            padding: 0.5rem;
            border: none;
            background-color: #f0f4f8;
            cursor: pointer;
        }

        /* Badges */
        .badge {
            padding: 0.5em 1em;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Code Editor */
        .code-editor {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: none;
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            width: 100%;
            min-height: 250px;
            line-height: 1.5;
        }

        /* The Flyer Canvas */
        #flyer-canvas {
            background: white;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            margin: auto;
            transform-origin: center center;
            transition: transform 0.2s ease;
            min-width: 400px; 
            min-height: 400px;
        }

        .panel { display: none; animation: fadeIn 0.3s ease; }
        .panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader */
        #loader {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: var(--surface-color); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            body { height: auto; overflow: auto; background: var(--surface-color); }
            .wrapper { flex-direction: column-reverse; height: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; padding-bottom: 80px; }
            .main-content { 
                height: 60vh; min-height: 400px; 
                margin: 0; border-radius: 0 0 24px 24px;
                border: none; box-shadow: none; border-bottom: 1px solid #eee;
            }
            .preview-area { border-radius: 0; align-items: flex-start; padding-top: 30px; }
            #flyer-canvas { transform-origin: top center; margin-top: 10px; }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status"></div>
        <div class="text-dark fw-bold" style="letter-spacing: 1px;">MEMUAT APLIKASI...</div>
    </div>

    <!-- Hidden div for QR Generation -->
    <div id="qr-dump" style="display:none;"></div>

    <div class="wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0 fw-bold" style="color: var(--primary-color);"><i class="bi bi-palette2 me-2"></i>FlyerPro</h4>
                    <small class="text-muted fw-semibold" style="letter-spacing: 0.5px;">MATERIAL EDITION</small>
                </div>
                <span class="badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle" id="role-badge">USER</span>
            </div>

            <div class="sidebar-content">
                
                <!-- CREATOR PANEL (Renamed from Admin) -->
                <div id="creator-panel" class="panel">
                    <div class="mb-5">
                        <label class="d-block text-secondary fw-bold mb-3 small" style="letter-spacing:1px;">1. PILIH TEMPLATE</label>
                        <div class="row g-3">
                            <div class="col-4">
                                <button class="btn btn-preset w-100" onclick="loadPreset('promo')">
                                    <i class="bi bi-bag-check-fill text-primary"></i>
                                    <span class="fw-bold small">Promo</span>
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-preset w-100" onclick="loadPreset('event')">
                                    <i class="bi bi-calendar2-event-fill text-danger"></i>
                                    <span class="fw-bold small">Event</span>
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-preset w-100" onclick="loadPreset('cert')">
                                    <i class="bi bi-patch-check-fill text-warning"></i>
                                    <span class="fw-bold small">Sertif</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-5">
                        <label class="d-block text-secondary fw-bold mb-3 small" style="letter-spacing:1px;">2. TOOLS CREATOR</label>
                        
                        <!-- Add Text Variable -->
                        <div class="input-group mb-3">
                            <input type="text" id="varInput" class="form-control" placeholder="Label (ex: HARGA)" onkeypress="handleEnter(event, 'var')">
                            <button class="btn btn-outline-secondary px-3" type="button" onclick="addVariable()">
                                <i class="bi bi-plus-lg"></i> Teks
                            </button>
                        </div>

                        <!-- Add Image -->
                        <div class="input-group mb-3">
                            <input type="text" id="imgInput" class="form-control" placeholder="URL Gambar..." onkeypress="handleEnter(event, 'img')">
                            <button class="btn btn-outline-secondary px-3" type="button" onclick="insertImage()">
                                <i class="bi bi-image"></i> Img
                            </button>
                        </div>

                        <!-- Add QR -->
                        <button class="btn btn-light w-100 border text-muted py-3 rounded-4" onclick="insertQR()" style="border-style: dashed !important;">
                            <i class="bi bi-qr-code me-2"></i> Sisipkan Placeholder QR Code
                        </button>
                    </div>

                    <div class="mb-4">
                        <label class="d-block text-secondary fw-bold mb-3 small" style="letter-spacing:1px;">3. SOURCE CODE</label>
                        <textarea id="htmlInput" class="code-editor form-control" spellcheck="false" oninput="syncCodeToCanvas()"></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" onclick="saveTemplate()"><i class="bi bi-cloud-arrow-up-fill me-2"></i>Simpan Template</button>
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-secondary w-100 btn-sm" onclick="downloadHTML('Creator_Template')">Export HTML</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-secondary w-100 btn-sm" onclick="downloadImage('Master_Design')">Export PNG</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- USER PANEL -->
                <div id="user-panel" class="panel active">
                    <div class="card border-0 bg-primary-subtle mb-4" style="border-radius: 20px;">
                        <div class="card-body d-flex align-items-center p-4">
                            <div class="bg-white rounded-circle p-2 d-flex align-items-center justify-content-center me-3 text-primary shadow-sm" style="width:48px; height:48px;">
                                <i class="bi bi-pencil-fill fs-5"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-1 text-primary-emphasis">Kustomisasi Desain</h6>
                                <p class="mb-0 small text-muted" style="line-height: 1.3;">Ubah data di bawah untuk melihat hasil secara instan.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold small text-secondary">WARNA TEMA</label>
                        <input type="color" class="form-control form-control-color" id="colorPicker" value="#6750a4" title="Choose your color" oninput="updateColor(this.value)">
                    </div>

                    <div id="dynamic-form">
                        <!-- Inputs will be generated here -->
                        <div class="text-center text-muted py-5">
                            <div class="spinner-border spinner-border-sm mb-2 text-secondary"></div>
                            <p class="small">Memuat form...</p>
                        </div>
                    </div>

                    <hr class="my-5 border-secondary-subtle">

                    <div class="d-grid gap-3">
                        <button id="btnDownload" class="btn btn-primary btn-lg py-3 shadow-sm" onclick="downloadImage('Flyer_Final')">
                            <i class="bi bi-download me-2"></i>Download Gambar (FHD)
                        </button>
                        <button class="btn btn-outline-secondary" onclick="downloadHTML('Flyer_Saya')">
                            <i class="bi bi-filetype-html me-2"></i>Simpan sebagai File
                        </button>
                    </div>
                </div>

            </div>

            <!-- Footer / Switcher -->
            <div class="sidebar-footer d-flex justify-content-between align-items-center">
                <small class="text-muted fw-medium">&copy; 2026 onelabszz</small>
                <div class="form-check form-switch d-flex align-items-center gap-2">
                    <input class="form-check-input" type="checkbox" role="switch" id="modeSwitch" onchange="handleModeSwitch(this)" style="width: 3em; height: 1.5em; cursor: pointer;">
                    <label class="form-check-label small fw-bold text-secondary" for="modeSwitch">Creator Mode</label>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="preview-area" id="preview-container">
                <div id="flyer-canvas"></div>
            </div>
        </main>
    </div>

    <!-- PIN Modal -->
    <div class="modal fade" id="pinModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 24px;">
                <div class="modal-header border-0 pb-0 justify-content-center pt-4">
                    <h6 class="modal-title fw-bold text-center w-100">Akses Creator</h6>
                </div>
                <div class="modal-body text-center px-4">
                    <p class="small text-muted mb-3">Masukkan PIN keamanan untuk masuk ke mode editor.</p>
                    <input type="password" id="adminPinInput" class="form-control text-center text-primary fw-bold fs-3 mb-3" maxlength="6" inputmode="numeric" style="letter-spacing: 5px;">
                    <div id="pinError" class="text-danger small fw-bold animate__animated animate__shakeX" style="display:none;">PIN Salah!</div>
                </div>
                <div class="modal-footer border-0 pt-0 pb-4 px-4">
                    <div class="row w-100 g-2">
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-secondary w-100" data-bs-dismiss="modal">Batal</button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="btn btn-primary w-100" onclick="verifyPin()">Masuk</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main Logic -->
    <script>
        /**
         * GLOBAL CONFIGURATION
         */
        // URL Google Script Anda (Opsional)
        const API_URL = ""; 
        
        let RAW_TEMPLATE = "";
        let CURRENT_MODE = 'user'; // 'user' or 'creator'
        let CREATOR_PIN = "1234"; // Default PIN

        // Preset Templates (HTML Strings)
        const PRESETS = {
            promo: `<div style="width:400px; height:550px; background:white; position:relative; overflow:hidden; border:1px solid #f1f1f1;">
    <div style="height:220px; overflow:hidden;">
        <img src="https://images.unsplash.com/photo-1556740758-90de374c12ad?auto=format&fit=crop&w=400&q=80" style="width:100%; height:100%; object-fit:cover;">
    </div>
    <div style="position:absolute; top:20px; right:20px; background:var(--theme-color); color:white; padding:8px 15px; font-weight:bold; font-size:14px; border-radius:30px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
        BIG SALE
    </div>
    <div style="text-align:center; margin-top:-30px; position:relative; z-index:10; padding:0 20px;">
        <div style="background:white; padding:20px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.05);">
            <h2 style="color:var(--theme-color); font-size:48px; margin:0; font-weight:800; line-height:1;">{{DISKON}}%</h2>
            <p style="color:#999; margin:0 0 15px 0; font-size:12px; letter-spacing:1px;">OFF THIS WEEK</p>
            <h3 style="color:#333; margin:0 0 5px 0; font-size:20px;">{{NAMA_PRODUK}}</h3>
            <p style="color:#666; font-size:13px; margin-bottom:20px;">Penawaran terbatas, jangan lewatkan kesempatan ini.</p>
            <div style="margin:0 auto; width:100px;">{{QR_CODE}}</div>
        </div>
    </div>
    <div style="text-align:center; padding:20px; color:#aaa; font-size:10px;">
        www.websiteanda.com
    </div>
</div>`,

            event: `<div style="width:400px; height:600px; background:#111; color:white; font-family:'Plus Jakarta Sans', sans-serif; display:flex; flex-direction:column; position:relative;">
    <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(45deg, var(--theme-color), transparent 70%); opacity:0.2;"></div>
    <div style="padding:40px; position:relative; z-index:2; flex:1;">
        <div style="display:inline-block; border:1px solid rgba(255,255,255,0.3); padding:5px 12px; border-radius:20px; font-size:10px; letter-spacing:1px; margin-bottom:20px;">ONLINE WEBINAR</div>
        <h1 style="font-size:42px; line-height:1.1; margin:0 0 20px 0; font-weight:800;">{{JUDUL_ACARA}}</h1>
        <p style="color:#ccc; font-size:14px; line-height:1.6;">Pelajari strategi terbaik langsung dari ahlinya dalam sesi eksklusif ini.</p>
        
        <div style="margin-top:40px; display:flex; align-items:center; gap:15px;">
            <div style="width:50px; height:50px; background:#333; border-radius:50%; overflow:hidden;">
                <img src="https://ui-avatars.com/api/?name=Speaker&background=random" style="width:100%;">
            </div>
            <div>
                <p style="margin:0; font-size:12px; color:#888;">SPEAKER</p>
                <p style="margin:0; font-weight:bold; font-size:16px;">{{PEMBICARA}}</p>
            </div>
        </div>
    </div>
    <div style="background:#222; padding:20px 40px; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <p style="margin:0; font-size:11px; color:var(--theme-color); font-weight:bold;">TANGGAL</p>
            <p style="margin:0; font-size:16px; font-weight:bold;">{{TANGGAL}}</p>
        </div>
        <div style="background:white; padding:5px; border-radius:4px;">{{QR_CODE}}</div>
    </div>
</div>`,

            cert: `<div style="width:800px; height:560px; background:#fff; padding:40px; border:10px solid var(--theme-color); position:relative; font-family:'Times New Roman', serif; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
    <div style="position:absolute; top:30px; left:30px; border-top:2px solid var(--theme-color); border-left:2px solid var(--theme-color); width:50px; height:50px;"></div>
    <div style="position:absolute; bottom:30px; right:30px; border-bottom:2px solid var(--theme-color); border-right:2px solid var(--theme-color); width:50px; height:50px;"></div>
    
    <h1 style="font-size:60px; color:var(--theme-color); margin:0; text-transform:uppercase; letter-spacing:5px;">Sertifikat</h1>
    <p style="font-size:18px; color:#666; margin-top:5px; font-style:italic;">Penghargaan ini diberikan kepada:</p>
    
    <h2 style="font-size:48px; margin:20px 0 10px 0; color:#222; border-bottom:1px solid #ddd; padding:0 40px 10px 40px;">{{NAMA_PESERTA}}</h2>
    
    <p style="font-size:16px; color:#555; max-width:600px; line-height:1.6;">Atas partisipasi dan dedikasinya yang luar biasa dalam mengikuti kegiatan:</p>
    <h3 style="font-size:28px; color:var(--theme-color); margin:10px 0 30px 0;">{{NAMA_ACARA}}</h3>
    
    <div style="display:flex; justify-content:space-between; width:100%; padding:0 60px; margin-top:30px;">
        <div style="text-align:center;">
            {{QR_CODE}}
            <p style="font-size:10px; color:#999; margin-top:5px;">SCAN VERIFIKASI</p>
        </div>
        <div style="text-align:center; min-width:200px;">
            <div style="height:60px; display:flex; align-items:end; justify-content:center;"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f8/Signature_sample.svg" style="height:40px; opacity:0.6;"></div>
            <div style="border-top:1px solid #333; margin-top:5px; padding-top:5px;">
                <p style="margin:0; font-weight:bold;">Ketua Panitia</p>
            </div>
        </div>
    </div>
</div>`
        };

        // --- INITIALIZATION ---
        window.onload = function() {
            setTimeout(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const modeParam = urlParams.get('mode');
                
                if(API_URL) {
                    fetch(API_URL + "?action=getSettings")
                        .then(res => res.json())
                        .then(data => {
                            if(data.PasscodeAdmin) {
                                CREATOR_PIN = data.PasscodeAdmin;
                            }
                            if (modeParam && modeParam === data.PasscodeAdmin) {
                                document.getElementById('modeSwitch').checked = true;
                                toggleMode(true);
                                if(data.TemplateAktif) loadHtmlToCanvas(data.TemplateAktif);
                                else loadPreset('promo');
                            } else {
                                if(data.TemplateAktif) RAW_TEMPLATE = data.TemplateAktif;
                                else RAW_TEMPLATE = PRESETS.promo;
                                initUser(RAW_TEMPLATE);
                            }
                            finishLoading();
                        })
                        .catch(err => {
                            console.warn("API Error/Offline", err);
                            useLocalDefault();
                        });
                } else {
                    useLocalDefault();
                }
            }, 800);
        };

        function useLocalDefault() {
            loadPreset('promo');
            finishLoading();
        }

        function finishLoading() {
            document.getElementById('loader').style.display = 'none';
            fitPreviewToScreen();
        }

        function handleModeSwitch(checkbox) {
            if (checkbox.checked) {
                checkbox.checked = false; // Wait for PIN
                const pinModalEl = document.getElementById('pinModal');
                const modal = new bootstrap.Modal(pinModalEl);
                document.getElementById('adminPinInput').value = '';
                document.getElementById('pinError').style.display = 'none';
                modal.show();
                pinModalEl.addEventListener('shown.bs.modal', function () {
                    document.getElementById('adminPinInput').focus();
                }, {once:true});
            } else {
                toggleMode(false);
            }
        }

        function verifyPin() {
            const input = document.getElementById('adminPinInput').value;
            if (input === CREATOR_PIN) {
                const el = document.getElementById('pinModal');
                const modal = bootstrap.Modal.getInstance(el);
                modal.hide();
                document.getElementById('modeSwitch').checked = true;
                toggleMode(true);
            } else {
                const err = document.getElementById('pinError');
                err.style.display = 'block';
                err.innerText = "PIN Salah! Silakan coba lagi.";
                const inputEl = document.getElementById('adminPinInput');
                inputEl.value = '';
                inputEl.focus();
            }
        }

        document.getElementById('adminPinInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verifyPin();
        });

        function toggleMode(isCreator) {
            const creatorPanel = document.getElementById('creator-panel');
            const userPanel = document.getElementById('user-panel');
            const roleBadge = document.getElementById('role-badge');
            
            if (isCreator) {
                CURRENT_MODE = 'creator';
                creatorPanel.classList.add('active');
                userPanel.classList.remove('active');
                roleBadge.className = 'badge rounded-pill bg-danger-subtle text-danger border border-danger-subtle';
                roleBadge.innerText = 'CREATOR';
                
                const currentHtml = document.getElementById('flyer-canvas').innerHTML;
                document.getElementById('htmlInput').value = currentHtml;
                makeCanvasEditable(true);
            } else {
                CURRENT_MODE = 'user';
                creatorPanel.classList.remove('active');
                userPanel.classList.add('active');
                roleBadge.className = 'badge rounded-pill bg-primary-subtle text-primary border border-primary-subtle';
                roleBadge.innerText = 'USER';

                RAW_TEMPLATE = document.getElementById('htmlInput').value || document.getElementById('flyer-canvas').innerHTML;
                initUser(RAW_TEMPLATE);
                makeCanvasEditable(false);
            }
        }

        function makeCanvasEditable(isEditable) {
            const canvas = document.getElementById('flyer-canvas');
            if(isEditable) {
                canvas.setAttribute('contenteditable', 'true');
                canvas.oninput = function() {
                    document.getElementById('htmlInput').value = canvas.innerHTML;
                };
            } else {
                canvas.removeAttribute('contenteditable');
                canvas.oninput = null;
            }
        }

        // --- CREATOR FUNCTIONS ---

        function loadPreset(type) {
            const code = PRESETS[type];
            loadHtmlToCanvas(code);
        }

        function loadHtmlToCanvas(html) {
            const canvas = document.getElementById('flyer-canvas');
            canvas.innerHTML = html;
            canvas.style.setProperty('--theme-color', document.getElementById('colorPicker').value);
            
            if(CURRENT_MODE === 'creator') {
                document.getElementById('htmlInput').value = html;
            } else {
                RAW_TEMPLATE = html;
                initUser(html);
            }
            setTimeout(fitPreviewToScreen, 50);
        }

        function syncCodeToCanvas() {
            const code = document.getElementById('htmlInput').value;
            document.getElementById('flyer-canvas').innerHTML = code;
        }

        function addVariable() {
            const val = document.getElementById('varInput').value.trim().toUpperCase().replace(/\s+/g, '_');
            if(!val) return;
            insertAtCursor(`{{${val}}}`);
            document.getElementById('varInput').value = "";
        }

        function insertImage() {
            const url = document.getElementById('imgInput').value.trim();
            if(!url) { alert("Masukkan URL gambar!"); return; }
            const imgTag = `<img src="${url}" style="width:100%; max-width:200px; display:block; margin:10px auto; border-radius:8px;">`;
            insertAtCursor(imgTag);
            document.getElementById('imgInput').value = "";
        }

        function insertQR() {
            insertAtCursor(`<div style="display:inline-block; background:#f8f9fa; color:#adb5bd; padding:15px; border:2px dashed #dee2e6; font-size:10px; text-align:center;">{{QR_CODE}}</div>`);
        }

        function insertAtCursor(text) {
            const input = document.getElementById('htmlInput');
            const scrollPos = input.scrollTop;
            const pos = input.selectionStart;
            const front = input.value.substring(0, pos);
            const back = input.value.substring(pos, input.value.length);
            input.value = front + text + back;
            input.selectionStart = pos + text.length;
            input.selectionEnd = pos + text.length;
            input.scrollTop = scrollPos;
            syncCodeToCanvas();
        }

        function saveTemplate() {
            if(!API_URL) {
                alert("Mode Offline: Template tersimpan di memori browser (sementara).");
                return;
            }
            const code = document.getElementById('htmlInput').value;
            const btn = document.querySelector('button[onclick="saveTemplate()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Menyimpan...'; btn.disabled = true;

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: "saveTemplate", payload: code })
            }).then(res => res.json()).then(data => {
                alert("Template Berhasil Disimpan!");
                btn.innerHTML = originalText; btn.disabled = false;
            }).catch(e => {
                alert("Gagal menyimpan: " + e);
                btn.innerHTML = originalText; btn.disabled = false;
            });
        }

        // --- USER FUNCTIONS ---

        function initUser(htmlCode) {
            generateForm(htmlCode);
            updateContent();
        }

        function updateColor(color) {
            document.getElementById('flyer-canvas').style.setProperty('--theme-color', color);
        }

        function generateForm(htmlCode) {
            const container = document.getElementById('dynamic-form');
            container.innerHTML = "";
            const regex = /{{\s*([a-zA-Z0-9_]+)\s*}}/g;
            let match;
            const uniqueLabels = new Set();
            let hasQR = false;

            while ((match = regex.exec(htmlCode)) !== null) {
                const label = match[1].trim();
                if (label === 'QR_CODE') {
                    hasQR = true;
                } else if (!uniqueLabels.has(label)) {
                    uniqueLabels.add(label);
                    
                    const div = document.createElement('div');
                    div.className = 'mb-4';
                    div.innerHTML = `
                        <label class="form-label text-capitalize fw-bold text-secondary small">${label.replace(/_/g, ' ')}</label>
                        <input type="text" class="form-control" data-target="${label}" placeholder="Ketik disini..." onkeyup="updateContent()">
                    `;
                    container.appendChild(div);
                }
            }

            if (hasQR) {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-white border border-light rounded-4 shadow-sm';
                div.innerHTML = `
                    <label class="form-label fw-bold small text-dark"><i class="bi bi-qr-code me-1"></i>Isi Konten QR Code</label>
                    <input type="text" id="qrInput" class="form-control" placeholder="https://..." onkeyup="generateQR()">
                `;
                container.prepend(div);
            }
            
            if(uniqueLabels.size === 0 && !hasQR) {
                container.innerHTML = `<div class="alert alert-info border-0 bg-info-subtle small"><i class="bi bi-info-circle me-2"></i>Tidak ada input dinamis ditemukan.</div>`;
            }
        }

        function updateContent() {
            let currentHTML = RAW_TEMPLATE;
            document.querySelectorAll('#dynamic-form input:not(#qrInput)').forEach(input => {
                const target = input.getAttribute('data-target');
                const val = input.value || target;
                const reg = new RegExp("{{\\s*" + target + "\\s*}}", "g");
                currentHTML = currentHTML.replace(reg, val);
            });

            const canvas = document.getElementById('flyer-canvas');
            const oldQR = canvas.querySelector('#live-qr');
            
            canvas.innerHTML = currentHTML;
            canvas.style.setProperty('--theme-color', document.getElementById('colorPicker').value);

            if(document.getElementById('qrInput')?.value && oldQR) {
                if(canvas.innerHTML.includes('{{QR_CODE}}')) {
                    canvas.innerHTML = canvas.innerHTML.replace('{{QR_CODE}}', oldQR.outerHTML);
                }
            } else if (document.getElementById('qrInput')?.value) {
                generateQR();
            }
        }

        function generateQR() {
            const text = document.getElementById('qrInput').value;
            const canvas = document.getElementById('flyer-canvas');
            
            if (!text) {
                if(canvas.innerHTML.includes('<img id="live-qr"')) {
                    updateContent();
                }
                return;
            }

            const dump = document.getElementById('qr-dump');
            dump.innerHTML = "";
            new QRCode(dump, {
                text: text,
                width: 512, // Higher res QR for FHD
                height: 512,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            setTimeout(() => {
                const imgQR = dump.querySelector('img');
                if (imgQR) {
                    const imgTag = `<img src="${imgQR.src}" id="live-qr" style="width:100%; display:block; height:auto;">`;
                    if (canvas.innerHTML.includes('{{QR_CODE}}')) {
                        canvas.innerHTML = canvas.innerHTML.replace('{{QR_CODE}}', imgTag);
                    } else {
                        const existing = canvas.querySelector('#live-qr');
                        if(existing) existing.src = imgQR.src;
                    }
                }
            }, 50);
        }

        // --- EXPORT & UTILS ---

        function downloadImage(filename) {
            const element = document.getElementById('flyer-canvas');
            const btn = document.getElementById('btnDownload');
            if(btn) { btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rendering...'; btn.disabled = true; }

            const originalTransform = element.style.transform;
            element.style.transform = 'none';

            // Scale factor: If flyer is small (e.g. 400px), scale 5x = 2000px width (FHD+ quality)
            const scale = 5; 

            html2canvas(element, {
                scale: scale,
                useCORS: true,
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename + '.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
                
                element.style.transform = originalTransform;
                if(btn) { btn.innerHTML = '<i class="bi bi-download me-2"></i>Download Gambar (FHD)'; btn.disabled = false; }
            }).catch(err => {
                alert("Error rendering image: " + err);
                element.style.transform = originalTransform;
                if(btn) { btn.innerHTML = '<i class="bi bi-download me-2"></i>Download Gambar (FHD)'; btn.disabled = false; }
            });
        }

        function downloadHTML(filename) {
            const content = document.getElementById('flyer-canvas').innerHTML;
            const fullHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${filename}</title></head><body style="background:#f0f0f0;display:flex;justify-content:center;padding:40px;"><div style="background:white;box-shadow:0 0 20px rgba(0,0,0,0.1);">${content}</div></body></html>`;
            const blob = new Blob([fullHtml], {type: 'text/html'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.html';
            link.click();
        }

        function handleEnter(e, type) {
            if(e.key === 'Enter') {
                if(type === 'var') addVariable();
                if(type === 'img') insertImage();
            }
        }

        function fitPreviewToScreen() {
            const container = document.getElementById('preview-container');
            const canvas = document.getElementById('flyer-canvas');
            if (!canvas || !container) return;
            canvas.style.transform = 'none';
            const padding = 60;
            const containerW = container.clientWidth - padding;
            const containerH = container.clientHeight - padding;
            const flyerW = canvas.offsetWidth;
            const flyerH = canvas.offsetHeight;
            if (flyerW === 0 || flyerH === 0) return;
            const scaleX = containerW / flyerW;
            const scaleY = containerH / flyerH;
            let scale = Math.min(scaleX, scaleY);
            if (scale > 1) scale = 1;
            canvas.style.transform = `scale(${scale})`;
        }

        window.addEventListener('resize', fitPreviewToScreen);

    </script>
</body>
</html>
